var dwpDarkMode = false;
(function ($) {
    /**
     * @param $scope The Widget wrapper element as a jQuery element
     * @param $ The jQuery alias
     */


    // Make sure you run this code under Elementor.
    $(window).on('elementor/frontend/init', function () {

        /* Dark Mode Settings */

        var dwp_darkmode_panel = elementorFrontendConfig.settings.dwp_darkmode_panel;
        if (dwp_darkmode_panel !== undefined && dwp_darkmode_panel.length !== 0) {
            dwpInitDarkMode();
        }


        function dwpInitDarkMode() {
            dwpDestroyDarkMode();
            dwpDarkMode = new Darkmode(dwpGetSettings());
            if (dwp_darkmode_panel.dwp_floating_darkmode) {
                dwpDarkMode.showWidget();
            }

            $(dwpDarkMode.layer).css('z-index', '1');
            $(dwpDarkMode.button).css('z-index', '9000');
            dwpPreventImageIssues();

        }

        function dwpDestroyDarkMode() {
            if (typeof dwpDarkMode.layer !== 'undefined' && typeof dwpDarkMode.button !== 'undefined') {
                dwpDarkMode.layer.remove();
                dwpDarkMode.button.remove();
            }
            $('.darkmode-background').remove();
        }

        function zIndexGet(e) {
            var zValue = parseInt($(this).css('zIndex', e));
            if (isNaN(zValue)) {
                return 0;
            }
            return zValue;
        }

        function dwpPreventImageIssues() {

            var sheet = window.document.styleSheets[0];
            sheet.insertRule('img { position: relative; }', sheet.cssRules.length);
            $('img').each(function () {
                $(this).css('z-index', zIndexGet($(this)) + 1);
            });

            $('[data-settings*=\'"background_background":"classic"\']').each(function () {
                if ($(this).css('background-image') === 'none') {
                    return;
                }
                $(this).css('z-index', zIndexGet($(this)) + 1);
            });

            $('[data-settings*=\'"background_background":"video"\'], [data-settings*=\'"background_background":"slideshow"\']').each(function () {
                $(this).css('z-index', zIndexGet($(this)) + 1);
            });
        }


        function dwpGetSettings() {
            var settings = {
                saveInCookies: dwp_darkmode_panel.save_in_cookies === 'yes',
                label: dwp_darkmode_panel.label,
                autoMatchOsTheme: dwp_darkmode_panel.match_os === 'yes',
                mixColor: dwp_darkmode_panel.site_bg,
                backgroundColor: dwp_darkmode_panel.site_bg,
                buttonColorDark: dwp_darkmode_panel.button_dark_bg,
                buttonColorLight: dwp_darkmode_panel.button_light_bg
            };
            switch (dwp_darkmode_panel.align_button) {
                case 'top-left':
                    settings.right = 'unset';
                    settings.left = '45px';
                    settings.bottom = 'calc(95% - 45px)';
                    break;
                case 'bottom-left':
                    settings.right = 'unset';
                    settings.left = '45px';
                    settings.bottom = '45px';
                    break;
                case 'bottom-right':
                    settings.right = '45px';
                    settings.left = 'unset';
                    settings.bottom = '45px';
                    break;
                case 'top-right':
                    settings.right = '45px';
                    settings.left = 'unset';
                    settings.bottom = 'calc(95% - 45px)';
                    break;
                default :
                    settings.bottom = '32px';
                    settings.right = '32px';
                    settings.left = 'unset';
            }

            if (dwp_darkmode_panel.time) {
                settings.time = dwp_darkmode_panel.time.size + 's';
            }

            return settings;
        }

        /* Dark Mode Widget */

        elementorFrontend.hooks.addAction('frontend/element_ready/dwp-darkmode.default',
            function ($scope) {
                elementorFrontend.elementsHandler.addHandler(darkModeHandler, {
                    $element: $scope
                });
            }
        );

        var darkModeHandler = elementorModules.frontend.handlers.Base.extend({
            onInit: function () {
                elementorModules.frontend.handlers.Base.prototype.onInit.apply(this, arguments);
                this.run();
            },

            run: function () {
                if (dwpDarkMode) {
                    $(document).on('click', '.dwp-darkmode-button a', function () {
                        dwpDarkMode.toggle();
                        $('.darkmode-layer.darkmode-layer--button').toggleClass('darkmode-layer--expanded');
                    });
                }
            },

        });

    });

})(jQuery);
